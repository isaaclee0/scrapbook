{% extends "base.html" %}

{% block content %}
    <div class="sort-container">
        <div class="flex items-center space-x-3 bg-gray-50 px-3 py-2 rounded-lg">
            <label for="boardSizeSlider" class="text-sm font-medium text-gray-700">Size:</label>
            <input type="range" id="boardSizeSlider" min="1" max="5" value="3" class="w-20 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
            <span id="boardSizeValue" class="text-sm font-medium text-gray-700 min-w-[4rem]">Medium</span>
        </div>
        <select id="sortBoards" onchange="sortBoards()">
            <option value="name_asc">Alphabetically (A to Z)</option>
            <option value="name_desc">Alphabetically (Z to A)</option>
            <option value="newest">Newest to Oldest</option>
            <option value="oldest">Oldest to Newest</option>
            <option value="largest">Largest to Smallest</option>
            <option value="smallest">Smallest to Largest</option>
        </select>
    </div>

    <div class="gallery" id="boardsGallery">
        {% for board in boards %}
        <div class="board" data-name="{{ board.name }}" data-created="{{ board.created_at }}" data-pin-count="{{ board.pin_count }}">
            <a href="{{ url_for('board', board_id=board.id) }}">
                <div class="board-image-container">
                    <div class="board-skeleton-loader"></div>
                    <img src="{{ board.random_pin_image_url }}" 
                         alt="{{ board.name }} Pin" 
                         loading="lazy"
                         class="board-image"
                         onerror="this.src='/static/images/default_board.png'"
                         onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';">
                </div>
                <h3>{{ board.name }}</h3>
            </a>
        </div>
        {% endfor %}
    </div>

    <style>
        .sort-container {
            padding: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
        }

        #sortBoards {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }

        #sortBoards:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.1);
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(var(--board-tile-size, 200px), 1fr));
            gap: 16px;
            padding: 20px;
        }
        .board {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            transition: transform 0.2s;
            background: white;
        }
        .board:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .board-image-container {
            position: relative;
            width: var(--board-image-size, 150px);
            height: var(--board-image-size, 150px);
            margin: 0 auto 10px;
            border-radius: 50%;
            overflow: hidden;
        }
        .board-skeleton-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                rgba(240, 240, 240, 0.8) 0%,
                rgba(220, 220, 220, 1) 50%,
                rgba(240, 240, 240, 0.8) 100%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 50%;
            z-index: 1;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .board-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: block;
            background-color: #f0f0f0;
            transition: width 0.2s, height 0.2s, opacity 0.3s;
            position: relative;
            z-index: 2;
            opacity: 0;
        }
        .board-image.loaded {
            opacity: 1;
        }
        .board h3 {
            margin: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            color: #333;
        }
        .board a {
            text-decoration: none;
        }
        @media (max-width: 600px) {
            .gallery { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            /* Board image size on mobile scales down slightly but still respects the slider */
            .board-image-container {
                width: calc(var(--board-image-size, 150px) * 0.75);
                height: calc(var(--board-image-size, 150px) * 0.75);
            }
        }
    </style>

    <script>
        // Board size slider handling
        document.addEventListener('DOMContentLoaded', function() {
            const boardSizeSlider = document.getElementById('boardSizeSlider');
            const boardSizeValue = document.getElementById('boardSizeValue');
            
            if (boardSizeSlider && boardSizeValue) {
                const sizeLabels = ['Tiny', 'Small', 'Medium', 'Large', 'Huge'];
                
                function updateBoardSize() {
                    const sizeLevel = parseInt(boardSizeSlider.value);
                    const sizeLabel = sizeLabels[sizeLevel - 1];
                    boardSizeValue.textContent = sizeLabel;
                    localStorage.setItem('boardTileSize', sizeLevel);
                    
                    // Adjust tile size and image size based on slider
                    const tileSizes = {
                        1: '150px',  // Tiny - smaller tiles, more columns
                        2: '180px',  // Small
                        3: '200px',  // Medium (default)
                        4: '250px',  // Large
                        5: '320px'   // Huge - larger tiles, fewer columns
                    };
                    
                    const imageSizes = {
                        1: '100px',  // Tiny
                        2: '120px',  // Small
                        3: '150px',  // Medium (default)
                        4: '180px',  // Large
                        5: '220px'   // Huge
                    };
                    
                    const tileSize = tileSizes[sizeLevel] || tileSizes[3];
                    const imageSize = imageSizes[sizeLevel] || imageSizes[3];
                    
                    document.documentElement.style.setProperty('--board-tile-size', tileSize);
                    document.documentElement.style.setProperty('--board-image-size', imageSize);
                }
                
                // Debounced update function for smoother slider experience
                let updateTimeout;
                function debouncedUpdateBoardSize() {
                    clearTimeout(updateTimeout);
                    updateTimeout = setTimeout(updateBoardSize, 50);
                }
                
                boardSizeSlider.addEventListener('input', debouncedUpdateBoardSize);
                boardSizeSlider.addEventListener('change', updateBoardSize);
                
                // Load saved board size from localStorage
                const savedBoardSize = localStorage.getItem('boardTileSize') || 3;
                boardSizeSlider.value = savedBoardSize;
                boardSizeValue.textContent = sizeLabels[savedBoardSize - 1];
                
                // Set initial board size
                updateBoardSize();
            }
        });

        // Debounce the sort function to prevent rapid re-sorting
        let sortTimeout;
        function sortBoards() {
            clearTimeout(sortTimeout);
            sortTimeout = setTimeout(performSort, 100);
        }

        function performSort() {
            const sortBy = document.getElementById('sortBoards').value;
            const gallery = document.getElementById('boardsGallery');
            const boards = Array.from(gallery.getElementsByClassName('board'));
            
            boards.sort((a, b) => {
                switch(sortBy) {
                    case 'name_asc':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    case 'name_desc':
                        return b.dataset.name.localeCompare(a.dataset.name);
                    case 'newest':
                        return new Date(b.dataset.created) - new Date(a.dataset.created);
                    case 'oldest':
                        return new Date(a.dataset.created) - new Date(b.dataset.created);
                    case 'largest':
                        return parseInt(b.dataset.pinCount) - parseInt(a.dataset.pinCount);
                    case 'smallest':
                        return parseInt(a.dataset.pinCount) - parseInt(b.dataset.pinCount);
                    default:
                        return 0;
                }
            });
            
            // Use requestAnimationFrame for smooth animations
            requestAnimationFrame(() => {
                gallery.innerHTML = '';
                boards.forEach(board => gallery.appendChild(board));
            });
        }

        // Handle image loading states
        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('.board-image');
            images.forEach(img => {
                if (img.complete && img.naturalHeight !== 0) {
                    // Image already loaded
                    img.classList.add('loaded');
                    const skeleton = img.previousElementSibling;
                    if (skeleton && skeleton.classList.contains('board-skeleton-loader')) {
                        skeleton.style.display = 'none';
                    }
                }
            });
        });
    </script>
{% endblock %}